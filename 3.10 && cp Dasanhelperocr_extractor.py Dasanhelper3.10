"""
화면 캡처 및 템플릿 매칭 모듈
"""

import mss
import cv2
import numpy as np
from pathlib import Path
from typing import Optional, Tuple


class ScreenCapture:
    def __init__(self, template_dir="images"):
        """화면 캡처 초기화"""
        self.template_dir = Path(template_dir)
        self.sct = mss.mss()

    def capture_screen(self, monitor_number=1):
        """화면 캡처

        Args:
            monitor_number: 모니터 번호 (1부터 시작)

        Returns:
            numpy array: 캡처된 이미지
        """
        monitor = self.sct.monitors[monitor_number]
        screenshot = self.sct.grab(monitor)

        # BGRA to BGR 변환
        img = np.array(screenshot)
        img = cv2.cvtColor(img, cv2.COLOR_BGRA2BGR)

        return img

    def find_template_in_screen(self, template_path, threshold=0.7):
        """화면에서 템플릿 이미지 찾기

        Args:
            template_path: 템플릿 이미지 경로
            threshold: 매칭 임계값 (0~1)

        Returns:
            tuple: (찾았는지 여부, 좌표 (x, y, w, h))
        """
        # 화면 캡처
        screen = self.capture_screen()

        # 템플릿 로드
        template = cv2.imread(str(template_path))
        if template is None:
            print(f"템플릿을 로드할 수 없습니다: {template_path}")
            return False, None

        # 템플릿 매칭
        result = cv2.matchTemplate(screen, template, cv2.TM_CCOEFF_NORMED)
        min_val, max_val, min_loc, max_loc = cv2.minMaxLoc(result)

        # 임계값 이상이면 찾음
        if max_val >= threshold:
            h, w = template.shape[:2]
            x, y = max_loc
            return True, (x, y, w, h)

        return False, None

    def is_emr_window_active(self, threshold=0.6):
        """EMR 창이 활성화되어 있는지 확인

        Args:
            threshold: 매칭 임계값

        Returns:
            bool: EMR 창 활성 여부
        """
        # images 폴더의 모든 이미지로 확인
        for template_file in self.template_dir.glob("*.jpg"):
            found, _ = self.find_template_in_screen(template_file, threshold)
            if found:
                return True

        for template_file in self.template_dir.glob("*.png"):
            found, _ = self.find_template_in_screen(template_file, threshold)
            if found:
                return True

        return False

    def capture_region(self, x, y, width, height):
        """특정 영역 캡처

        Args:
            x, y: 시작 좌표
            width, height: 크기

        Returns:
            numpy array: 캡처된 이미지
        """
        monitor = {"top": y, "left": x, "width": width, "height": height}
        screenshot = self.sct.grab(monitor)

        # BGRA to BGR 변환
        img = np.array(screenshot)
        img = cv2.cvtColor(img, cv2.COLOR_BGRA2BGR)

        return img

    def save_screenshot(self, filename="screenshot.png"):
        """스크린샷 저장 (디버깅용)"""
        img = self.capture_screen()
        cv2.imwrite(filename, img)
        print(f"스크린샷 저장: {filename}")
