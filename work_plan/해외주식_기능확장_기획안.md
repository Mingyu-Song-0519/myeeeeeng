# 해외 주식 기능 확장 기획안

## 📋 현재 구현 상태

### ✅ 완료된 기능
| 항목 | 상태 | 설명 |
|---|---|---|
| **시장 전환 UI** | ✅ | 사이드바에서 🇰🇷 한국 ↔ 🇺🇸 미국 전환 가능 |
| **미국 종목 하드코딩 목록** | ✅ | 42개 인기 종목 (AAPL, MSFT 등) + ETF (SPY, QQQ) |
| **통화 기호 전환** | ✅ | ₩ ↔ $ 자동 전환 |
| **ticker 접미사 처리** | ✅ | .KS 접미사 조건부 적용 |
| **일부 탭 시장 분기** | ⚠️ | 단일 종목, AI 예측, 백테스트, 포트폴리오, 리스크 관리 |

### ❌ 미완료/개선 필요
| 항목 | 현재 상태 | 필요 작업 |
|---|---|---|
| **미국 종목 전체 검색** | 42개 고정 | NYSE/NASDAQ 전체 목록 동적 로딩 |
| **뉴스 감성 분석** | 🇰🇷 전용 | 영문 뉴스 소스 추가 (Yahoo, Seeking Alpha 등) |
| **실시간 시세** | 🇰🇷 전용 | 미국 실시간 데이터 소스 필요 (또는 비활성화) |
| **다중 종목 비교** | 부분 지원 | 미국 시장 완전 통합 필요 |
| **AI 모델** | 🇰🇷 학습 모델만 | 미국 종목용 모델 학습 또는 범용화 |

---

## 🎯 구현 목표

### Phase 1: 기본 기능 완성 (필수)
1. **미국 종목 전체 리스트 로딩**
   - FinanceDataReader로 NYSE/NASDAQ 전체 종목 가져오기
   - 캐싱 적용으로 성능 최적화

2. **뉴스 감성 분석 영문 지원**
   - Yahoo Finance News RSS 추가
   - 영문 감성 분석기 (VADER/TextBlob 활용)

3. **실시간 시세 탭 처리**
   - 미국 시장 선택 시 "지원 예정" 메시지 표시
   - 또는 yfinance 실시간 스냅샷 제공

### Phase 2: 고급 기능 (선택)
4. **AI 예측 모델 범용화**
   - 미국 종목에도 기존 LSTM/Transformer 적용
   - 모델 저장 경로에 시장 구분 추가

5. **다중 시장 포트폴리오**
   - 한국+미국 종목 혼합 포트폴리오 최적화
   - 환율 변동 고려

---

## 📁 수정 대상 파일

### [MODIFY] app.py
- 미국 종목 리스트 동적 로딩 (`fdr.StockListing('NASDAQ')`, `fdr.StockListing('NYSE')`)
- 실시간 시세 탭 미국 시장 처리

### [MODIFY] news_collector.py
- Yahoo Finance News RSS 수집 메서드 추가
- 영문 뉴스 파싱 로직

### [MODIFY] sentiment_analyzer.py
- 영문 텍스트 감성 분석 분기 추가
- VADER 또는 TextBlob 영문 모드 활용

### [MODIFY] realtime_tab.py
- 미국 시장 선택 시 대체 UI 표시

---

## ✅ 검증 계획

### 자동 테스트
- [ ] 미국 시장 선택 후 종목 리스트 로딩 확인
- [ ] 미국 종목 차트 데이터 정상 표시
- [ ] 영문 뉴스 수집 및 감성 분석 작동

### 수동 확인
- [ ] Streamlit Cloud 배포 후 미국 시장 기능 테스트
- [ ] 모바일 UI에서 시장 전환 및 사용성 확인

---

## 📝 보완 사항 (2025-12-22 검토)

### 1. 현재 구현 상태 업데이트

#### ✅ 추가 완료된 기능
| 항목 | 상태 | 근거 |
|---|---|---|
| **FinanceDataReader 통합** | ✅ | KRX 종목 리스트 동적 로딩 구현 완료 (커밋 1904e87) |
| **모바일 반응형 UI** | ✅ | CSS clamp 기반 반응형 폰트 사이징 적용 (커밋 d96457d) |
| **영문 감성 분석 준비** | ⚠️ | VADER, TextBlob 라이브러리 설치 완료 (requirements.txt), import 구조만 준비됨 |

### 2. Phase 1 구현 목표 재조정

#### Phase 1A: 핵심 기능 (우선순위 최상 - 1-2일)
1. **미국 종목 전체 리스트 동적 로딩**
   - 기존: FinanceDataReader 도입 필요 → **수정**: 이미 도입 완료, NYSE/NASDAQ 적용만 필요
   - `fdr.StockListing('NASDAQ')`, `fdr.StockListing('NYSE')` 활용
   - 한국 종목과 동일한 캐싱 전략 적용

2. **시장별 ticker 접미사 처리 로직 개선**
   - 현재: .KS 접미사 조건부 적용
   - 개선: 미국 종목은 접미사 추가 금지 (AAPL → AAPL, 005930 → 005930.KS)
   - stock_collector.py 수정 필요

3. **실시간 시세 탭 미국 시장 처리**
   - 현재: KIS API 전용 (한국투자증권)
   - 옵션 1: 미국 시장 선택 시 탭 비활성화
   - 옵션 2: yfinance 15분 지연 데이터 제공 (단, "준실시간" 표기 필수)
   - **권장**: 옵션 1 (API 제약사항 명확히 안내)

#### Phase 1B: 필수 기능 (2-3일)
4. **영문 뉴스 수집**
   - Yahoo Finance News RSS 추가
   - 현재 news_collector.py는 네이버 금융 + Google News만 지원
   - 새 메서드: `collect_yahoo_finance_news(ticker, lang='en')`

5. **영문 감성 분석 분기**
   - sentiment_analyzer.py에 언어 감지 로직 추가
   - 영문: VADER 또는 TextBlob 사용
   - 한글: 기존 KR-FinBert 또는 rule-based 사용

6. **환율 데이터 통합**
   - 미국 주식 가격 원화 환산 옵션
   - yfinance `Ticker("USDKRW=X")` 또는 한국은행 API
   - config.py에 `EXCHANGE_RATE_SOURCE` 설정 추가

#### Phase 1C: 선택 기능 (1일)
7. **다중 종목 비교 탭 미국 시장 통합**
   - 한국/미국 종목 혼합 비교 지원
   - 차트에 통화 단위 표시 (₩/$ 또는 통일)

### 3. 수정 대상 파일 추가

#### [MODIFY] config.py
```python
# 추가 필요 항목
MARKET_CONFIG = {
    "KR": {
        "suffix": ".KS",  # KOSPI
        "suffix_alt": ".KQ",  # KOSDAQ
        "currency": "KRW",
        "realtime_api": "KIS"
    },
    "US": {
        "suffix": "",  # 접미사 없음
        "currency": "USD",
        "realtime_api": None  # 실시간 미지원
    }
}

EXCHANGE_RATE_SOURCE = "yfinance"  # or "한국은행API"
```

#### [MODIFY] stock_collector.py
- `collect_stock_data(ticker, market='KR')` 파라미터 추가
- ticker 접미사 자동 추가 로직에 시장 구분 적용

#### [CREATE] currency_converter.py (선택)
- 환율 데이터 수집 및 캐싱
- `get_exchange_rate(base='USD', target='KRW')` 메서드

#### [MODIFY] realtime_tab.py
- 19-22라인 수정: 시장 구분 로직 추가
```python
if st.session_state.get('selected_market') == 'US':
    st.info("⚠️ 미국 실시간 시세는 현재 지원하지 않습니다.")
    return
```

### 4. 데이터베이스 스키마 확장

#### news 테이블 수정
```sql
ALTER TABLE news ADD COLUMN market TEXT DEFAULT 'KR';
CREATE INDEX idx_news_market ON news(market);
```
- 한국/미국 뉴스 구분 저장
- ticker 중복 방지 (AAPL vs 005930.KS)

### 5. 검증 계획 보강

#### 자동 테스트 추가
- [ ] 미국 종목 뉴스 수집 시 영문 감성 분석 점수 -1.0 ~ 1.0 범위 확인
- [ ] 한국/미국 종목 혼합 포트폴리오 최적화 시 환율 적용 검증
- [ ] 시장 전환 시 세션 상태 초기화 확인 (이전 시장 데이터 잔존 방지)
- [ ] ticker 접미사 처리: 한국 종목만 .KS/.KQ 추가 확인

#### 수동 확인 추가
- [ ] 미국 종목 ticker 입력 시 .KS 접미사 미추가 확인
- [ ] 다크모드/라이트모드에서 미국 주식 차트 색상 정상 표시
- [ ] 실시간 탭에서 미국 시장 선택 시 적절한 안내 메시지 표시
- [ ] 환율 변동 시 미국 주식 원화 환산 가격 업데이트 확인

### 6. 기술적 제약사항 및 위험 요소

#### ⚠️ API Rate Limiting
| 서비스 | 제약사항 | 대응 방안 |
|---|---|---|
| **yfinance** | 비공식 API, 과도한 요청 시 차단 | 1일 1회 전체 종목 리스트 캐싱 |
| **Yahoo Finance News** | RSS 크롤링 속도 제한 | 요청 간 1초 대기 (현재 구현됨) |
| **실시간 데이터** | 미국 주식 실시간 데이터 대부분 유료 | 15분 지연 데이터만 제공 또는 비활성화 |

#### 📜 라이선스 이슈
- yfinance: 15분 지연 데이터만 무료 사용 가능
- 실시간 데이터 제공 시 Polygon.io, Alpha Vantage 등 유료 API 필요
- 현재 프로젝트는 개인/교육용이므로 yfinance 사용 적절

#### 🤖 AI 모델 학습 데이터
- **현재 상태**: 한국 시장 데이터로만 학습된 LSTM/XGBoost 모델
- **문제점**: 미국 종목에 바로 적용 시 정확도 보장 불가
- **해결 방안**:
  - Phase 2에서 미국 종목 데이터로 별도 모델 학습
  - 또는 전이학습(Transfer Learning) 적용
  - 모델 파일 저장 경로: `saved_models/{market}/{ticker}_model.h5`

### 7. 우선순위 재조정 로드맵

```
┌─────────────────────────────────────────────────────────┐
│ Phase 1A (1-2일) - 핵심 기능                             │
├─────────────────────────────────────────────────────────┤
│ 1. 미국 종목 리스트 동적 로딩 (FinanceDataReader)        │
│ 2. ticker 접미사 처리 로직 수정                          │
│ 3. 실시간 탭 미국 시장 비활성화                          │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Phase 1B (2-3일) - 필수 기능                             │
├─────────────────────────────────────────────────────────┤
│ 4. Yahoo Finance 영문 뉴스 수집                         │
│ 5. VADER/TextBlob 영문 감성 분석                        │
│ 6. 환율 데이터 수집 및 표시                              │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Phase 1C (1일) - 선택 기능                               │
├─────────────────────────────────────────────────────────┤
│ 7. 다중 종목 비교 탭 미국 시장 통합                      │
│ 8. 차트 데이터 미국 종목 검증                            │
└─────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────┐
│ Phase 2 (3-5일) - 고급 기능                              │
├─────────────────────────────────────────────────────────┤
│ 9. AI 모델 미국 종목 학습                                │
│ 10. 혼합 포트폴리오 최적화 (환율 리스크 포함)            │
│ 11. 백테스트 미국 종목 지원                              │
└─────────────────────────────────────────────────────────┘
```

### 8. 즉시 조치 권장 사항

#### 🔍 사전 확인 필요
1. **config.py 전체 파일 확인**
   - US_TICKERS가 여전히 42개 하드코딩인지 확인
   - 동적 로딩 구현 여부 확인

2. **app.py 시장 전환 로직 확인**
   - `st.session_state['selected_market']` 관리 방식
   - 시장 전환 시 이전 데이터 초기화 여부

3. **FinanceDataReader 클라우드 동작 확인**
   - 최근 커밋에서 KRX 종목 리스트 구현 확인
   - 동일한 방식으로 NASDAQ/NYSE 적용 가능성 검증

#### 📋 첫 구현 추천 순서
1. config.py에 MARKET_CONFIG 추가
2. app.py에서 US 종목 리스트 동적 로딩 구현
3. realtime_tab.py 미국 시장 비활성화
4. 배포 후 기본 동작 테스트
5. 뉴스/감성 분석 추가

---

## 📌 참고사항

### 현재 프로젝트 기술 스택
- **백엔드**: Python 3.x
- **프론트엔드**: Streamlit
- **데이터 수집**: yfinance, FinanceDataReader
- **감성 분석**: KR-FinBert (한글), VADER/TextBlob (영문 준비됨)
- **AI 모델**: LSTM, XGBoost, Transformer
- **배포**: Streamlit Cloud

### 알려진 이슈
- 모바일 스크롤 개선 작업 완료 (최근 여러 커밋)
- requirements.txt에서 torch --index-url 제거 완료 (커밋 c7adfa5)
- sentiment_analyzer.py TEXTBLOB_AVAILABLE 정의 복원 완료 (커밋 4853630)
